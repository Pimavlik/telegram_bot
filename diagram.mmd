flowchart TD
  subgraph A[Покупатель]
    A1[Понимает, что закончились продукты и идет в магазин]
    A2[Берет корзинку и идет в торговый зал]
    A3[Подбирает товары по списку]
    A4[Идет к кассам и ждет очереди]
    A5[Выкладывает товары на ленту]
  end

  subgraph B[Кассир]
    B1[Начинает обслуживание]
    B3[Сканирует товары]
    B3d{Все товары пробиты?}
    B4[Предлагает акционные товары и пакет]
    B5[Озвучивает итог и спрашивает способ оплаты]
    B7[Пробивает чек и отпускает клиента]
    B8[Свободная касса]
  end

  subgraph S[ИС магазина]
    S2[Создает электронный документ продажа]
    S3[Фиксация каждого сканирования, транзакционно]
    S7[Документ продажа выполнен и оплачен]
    Sbnl[Формирует запрос безналичной оплаты и соединяется с банком]
  end

  subgraph E[Банк-эквайер]
    E1[Проверяет средства и возвращает ответ]
  end

  X[Прерывание процесса]

  A1 --> A2 --> A3 --> A4 --> A5 --> B1
  B1 --> S2
  S2 -- Ошибка --> X
  S2 -- Успех --> B3
  B3 --> S3 --> B3d
  B3d -- Нет --> B3
  B3d -- Да --> B4 --> B5

  P{Способ оплаты?}
  B5 --> P

  %% Безнал
  P -- Безнал --> Bn1[Инициирует безналичный режим]
  Bn1 --> Sbnl --> A6[Клиент подтверждает оплату]
  A6 --> E1
  E1 --> PayOK{Оплата успешна?}
  PayOK -- Нет --> X
  PayOK -- Да --> Paid[Покупка оплачена]

  %% Наличные/иные
  P -- Наличные/Подарочная/Комбинированно --> A7[Покупатель передает наличные или иные средства]
  A7 --> B6[Кассир принимает и при необходимости выдает сдачу]
  B6 --> Paid

  Paid --> B7 --> S7 --> B8
  B8 --> A8[Покупатель забирает товары/сдачу и уходит домой]
