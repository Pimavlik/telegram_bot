<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_Shopping" targetNamespace="https://example.com/bpmn/shopping">
  <!-- Messages and Signals -->
  <bpmn:message id="msg_ItemsOnBelt" name="Items on belt"/>
  <bpmn:message id="msg_CreateSale" name="Create Sale Document"/>
  <bpmn:message id="msg_ScanItem" name="Scan Item"/>
  <bpmn:message id="msg_PersistItem" name="Persist Item Transactionally"/>
  <bpmn:message id="msg_PaymentRequest" name="Payment Authorization Request"/>
  <bpmn:message id="msg_PaymentApproved" name="Payment Approved"/>
  <bpmn:message id="msg_PaymentDeclined" name="Payment Declined"/>
  <bpmn:message id="msg_CashHanded" name="Cash Handed Over"/>
  <bpmn:message id="msg_ChangeGiven" name="Change Given"/>
  <bpmn:signal id="sig_FreeCheckout" name="Free Checkout"/>

  <!-- Collaboration with participants -->
  <bpmn:collaboration id="Collab_Shopping">
    <bpmn:participant id="Pool_Customer" name="Покупатель" processRef="Process_Customer"/>
    <bpmn:participant id="Pool_Store" name="Магазин" processRef="Process_Store"/>
    <bpmn:participant id="Pool_Acquirer" name="Банк-эквайер" processRef="Process_Acquirer"/>

    <!-- Message Flows (declared here; elements referenced inside processes) -->
    <bpmn:messageFlow id="mf_ItemsOnBelt" name="Items on belt" sourceRef="Task_PutItemsOnBelt" targetRef="Start_Cashier_Service" messageRef="msg_ItemsOnBelt"/>

    <!-- Cashier -> IS: Create Sale -->
    <bpmn:messageFlow id="mf_CreateSale" name="Create Sale" sourceRef="Task_CreateSale" targetRef="Start_IS_CreateSale" messageRef="msg_CreateSale"/>

    <!-- Cashier -> IS: Scan Item; IS -> Cashier: Persist Ack -->
    <bpmn:messageFlow id="mf_ScanItem" name="Scan Item" sourceRef="Task_ScanItem" targetRef="Catch_IS_ScanItem" messageRef="msg_ScanItem"/>
    <bpmn:messageFlow id="mf_PersistAck" name="Persisted" sourceRef="Throw_IS_Persisted" targetRef="Catch_Cashier_Persisted" messageRef="msg_PersistItem"/>

    <!-- Noncash: Store IS <-> Acquirer -->
    <bpmn:messageFlow id="mf_PaymentRequest" name="Payment Request" sourceRef="Task_IS_SendPaymentReq" targetRef="Start_Acq_Authorize" messageRef="msg_PaymentRequest"/>
    <bpmn:messageFlow id="mf_PaymentApproved" name="Approved" sourceRef="Task_Acq_Approve" targetRef="Catch_IS_PaymentApproved" messageRef="msg_PaymentApproved"/>
    <bpmn:messageFlow id="mf_PaymentDeclined" name="Declined" sourceRef="Task_Acq_Decline" targetRef="Catch_IS_PaymentDeclined" messageRef="msg_PaymentDeclined"/>

    <!-- IS -> Cashier: authorization result -->
    <bpmn:messageFlow id="mf_IS_to_Cashier_Approved" name="Approved" sourceRef="Throw_IS_PaymentApproved" targetRef="Catch_Cashier_Approved" messageRef="msg_PaymentApproved"/>
    <bpmn:messageFlow id="mf_IS_to_Cashier_Declined" name="Declined" sourceRef="Throw_IS_PaymentDeclined" targetRef="Catch_Cashier_Declined" messageRef="msg_PaymentDeclined"/>

    <!-- Mixed: IS -> Cashier events inside subprocess -->
    <bpmn:messageFlow id="mf_IS_to_Mix_Approved" name="Approved" sourceRef="Throw_IS_PaymentApproved" targetRef="SP_Mix_Approved" messageRef="msg_PaymentApproved"/>
    <bpmn:messageFlow id="mf_IS_to_Mix_Declined" name="Declined" sourceRef="Throw_IS_PaymentDeclined" targetRef="SP_Mix_Declined" messageRef="msg_PaymentDeclined"/>

    <!-- Cash: Customer -> Cashier and back for change -->
    <bpmn:messageFlow id="mf_CashToCashier" name="Hand Cash" sourceRef="Task_Customer_HandCash" targetRef="Catch_Cashier_Cash" messageRef="msg_CashHanded"/>
    <bpmn:messageFlow id="mf_ChangeToCustomer" name="Give Change" sourceRef="Task_Cashier_GiveChange" targetRef="Catch_Customer_Change" messageRef="msg_ChangeGiven"/>
  </bpmn:collaboration>

  <!-- Customer process -->
  <bpmn:process id="Process_Customer" name="Покупатель" isExecutable="false">
    <bpmn:startEvent id="Start_NeedGroceries" name="Продукты закончились"/>
    <bpmn:sequenceFlow id="flow1" sourceRef="Start_NeedGroceries" targetRef="Task_GoToStore"/>

    <bpmn:userTask id="Task_GoToStore" name="Отправиться в магазин"/>
    <bpmn:sequenceFlow id="flow2" sourceRef="Task_GoToStore" targetRef="Task_TakeBasket"/>

    <bpmn:userTask id="Task_TakeBasket" name="Взять корзинку и пройти в зал"/>
    <bpmn:sequenceFlow id="flow3" sourceRef="Task_TakeBasket" targetRef="Task_SelectProducts"/>

    <bpmn:subProcess id="Task_SelectProducts" name="Подбор товаров (по списку)">
      <bpmn:multiInstanceLoopCharacteristics isSequential="false"/>
      <bpmn:startEvent id="SP_Start_Select"/>
      <bpmn:userTask id="SP_Task_PickItem" name="Выбрать товар"/>
      <bpmn:endEvent id="SP_End_Select"/>
      <bpmn:sequenceFlow id="sp_f1" sourceRef="SP_Start_Select" targetRef="SP_Task_PickItem"/>
      <bpmn:sequenceFlow id="sp_f2" sourceRef="SP_Task_PickItem" targetRef="SP_End_Select"/>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="flow4" sourceRef="Task_SelectProducts" targetRef="Task_WaitQueue"/>

    <bpmn:userTask id="Task_WaitQueue" name="Ждать очереди в зоне касс"/>
    <bpmn:sequenceFlow id="flow5" sourceRef="Task_WaitQueue" targetRef="Task_AwaitDivider"/>

    <bpmn:intermediateCatchEvent id="Task_AwaitDivider" name="Табличка на ленте: закончено">
      <bpmn:timerEventDefinition/>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="flow6" sourceRef="Task_AwaitDivider" targetRef="Task_PutItemsOnBelt"/>

    <bpmn:sendTask id="Task_PutItemsOnBelt" name="Выкладывать товары на ленту" messageRef="msg_ItemsOnBelt"/>
    <bpmn:sequenceFlow id="flow7" sourceRef="Task_PutItemsOnBelt" targetRef="Task_DecidePayment"/>

    <!-- Payment interaction from customer's side -->
    <bpmn:exclusiveGateway id="Task_DecidePayment" name="Выбор способа оплаты"/>
    <bpmn:sequenceFlow id="flow8_cashless" sourceRef="Task_DecidePayment" targetRef="Task_WaitApproval" name="Безнал"/>
    <bpmn:sequenceFlow id="flow8_cash" sourceRef="Task_DecidePayment" targetRef="Task_Customer_HandCash" name="Наличные"/>
    <bpmn:sequenceFlow id="flow8_mixed" sourceRef="Task_DecidePayment" targetRef="Task_WaitApproval" name="Смешанная"/>

    <bpmn:intermediateCatchEvent id="Task_WaitApproval" name="Ждать подтверждения оплаты">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="flow9" sourceRef="Task_WaitApproval" targetRef="End_TakeGoods"/>

    <bpmn:sendTask id="Task_Customer_HandCash" name="Передать наличные" messageRef="msg_CashHanded"/>
    <bpmn:sequenceFlow id="flow10" sourceRef="Task_Customer_HandCash" targetRef="Catch_Customer_Change"/>

    <bpmn:intermediateCatchEvent id="Catch_Customer_Change" name="Получить сдачу (при необходимости)">
      <bpmn:messageEventDefinition messageRef="msg_ChangeGiven"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="flow11" sourceRef="Catch_Customer_Change" targetRef="End_TakeGoods"/>

    <bpmn:endEvent id="End_TakeGoods" name="Забрать товары и уйти домой">
      <bpmn:terminateEventDefinition/>
    </bpmn:endEvent>
  </bpmn:process>

  <!-- Store (Cashier + IS) process -->
  <bpmn:process id="Process_Store" name="Магазин" isExecutable="false">
    <bpmn:laneSet id="LaneSet_Store">
      <bpmn:lane id="Lane_Cashier" name="Кассир">
        <bpmn:flowNodeRef>Start_Cashier_Service</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_CreateSale</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Sub_ScanItems</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_OfferPromos</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>GW_PromoAccepted</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_AnnounceTotal</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Gateway_PaymentChoice</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_InitiateCashless</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Approved</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Declined</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Persisted</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_ScanItem</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Cash</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_Cashier_GiveChange</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_PrintReceipt</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>End_FreeCheckout</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>End_Interrupted</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_IS" name="ИС Магазина">
        <bpmn:flowNodeRef>Start_IS_CreateSale</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_IS_RegisterSale</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_IS_ScanItem</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_IS_PersistItem</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Throw_IS_Persisted</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_IS_SendPaymentReq</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_IS_PaymentApproved</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_IS_PaymentDeclined</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Throw_IS_PaymentApproved</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Throw_IS_PaymentDeclined</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>

    <!-- Cashier: start when items on belt -->
    <bpmn:startEvent id="Start_Cashier_Service" name="Начать обслуживание">
      <bpmn:messageEventDefinition messageRef="msg_ItemsOnBelt"/>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="s1" sourceRef="Start_Cashier_Service" targetRef="Task_CreateSale"/>

    <bpmn:sendTask id="Task_CreateSale" name="Создать ЭД 'продажа'" messageRef="msg_CreateSale"/>
    <bpmn:boundaryEvent id="BE_CreateSale_Error" name="Ошибка создания" attachedToRef="Task_CreateSale" cancelActivity="true">
      <bpmn:errorEventDefinition/>
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="s1_err" sourceRef="BE_CreateSale_Error" targetRef="End_Interrupted"/>
    <bpmn:sequenceFlow id="s2" sourceRef="Task_CreateSale" targetRef="Sub_ScanItems"/>

    <!-- Scanning loop with transactional persistence ack from IS -->
    <bpmn:subProcess id="Sub_ScanItems" name="Пробить все товары">
      <bpmn:standardLoopCharacteristics testBefore="true">
        <bpmn:loopCondition xsi:type="bpmn:tFormalExpression">${hasMoreItems}</bpmn:loopCondition>
      </bpmn:standardLoopCharacteristics>

      <bpmn:startEvent id="SP_Start_Scan"/>
      <bpmn:sequenceFlow id="ss1" sourceRef="SP_Start_Scan" targetRef="Task_ScanItem"/>

      <bpmn:sendTask id="Task_ScanItem" name="Пробить товар" messageRef="msg_ScanItem"/>
      <bpmn:intermediateCatchEvent id="Catch_Cashier_Persisted" name="Сохранено (транзакционно)">
        <bpmn:messageEventDefinition messageRef="msg_PersistItem"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:sequenceFlow id="ss2" sourceRef="Task_ScanItem" targetRef="Catch_Cashier_Persisted"/>
      <bpmn:endEvent id="SP_End_Scan"/>
      <bpmn:sequenceFlow id="ss3" sourceRef="Catch_Cashier_Persisted" targetRef="SP_End_Scan"/>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="s3" sourceRef="Sub_ScanItems" targetRef="Task_OfferPromos"/>

    <bpmn:userTask id="Task_OfferPromos" name="Предложить акции и пакет"/>
    <bpmn:exclusiveGateway id="GW_PromoAccepted" name="Согласен?"/>
    <bpmn:sequenceFlow id="s4a" sourceRef="Task_OfferPromos" targetRef="GW_PromoAccepted"/>
    <bpmn:sequenceFlow id="s4b" sourceRef="GW_PromoAccepted" targetRef="Sub_ScanItems" name="Да"/>
    <bpmn:sequenceFlow id="s4c" sourceRef="GW_PromoAccepted" targetRef="Task_AnnounceTotal" name="Нет"/>

    <bpmn:userTask id="Task_AnnounceTotal" name="Озвучить сумму и спросить способ"/>
    <bpmn:exclusiveGateway id="Gateway_PaymentChoice" name="Способ оплаты"/>
    <bpmn:sequenceFlow id="s5d" sourceRef="Task_AnnounceTotal" targetRef="Gateway_PaymentChoice"/>
    <bpmn:sequenceFlow id="s5a" sourceRef="Gateway_PaymentChoice" targetRef="Task_InitiateCashless" name="Безнал"/>
    <bpmn:sequenceFlow id="s5b" sourceRef="Gateway_PaymentChoice" targetRef="Catch_Cashier_Cash" name="Наличные"/>
    <bpmn:sequenceFlow id="s5c" sourceRef="Gateway_PaymentChoice" targetRef="Sub_MixedPayment" name="Смешанная"/>

    <!-- Cashless path -->
    <bpmn:userTask id="Task_InitiateCashless" name="Инициировать безнал"/>
    <bpmn:sequenceFlow id="s6" sourceRef="Task_InitiateCashless" targetRef="Task_IS_SendPaymentReq"/>

    <bpmn:intermediateCatchEvent id="Catch_Cashier_Approved" name="Оплата подтверждена">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:intermediateCatchEvent id="Catch_Cashier_Declined" name="Отказ/таймаут">
      <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:exclusiveGateway id="GW_CashlessResult" name="Результат безнала"/>
    <bpmn:sequenceFlow id="s7a" sourceRef="Catch_Cashier_Approved" targetRef="GW_CashlessResult"/>
    <bpmn:sequenceFlow id="s7b" sourceRef="Catch_Cashier_Declined" targetRef="GW_CashlessResult"/>
    <bpmn:sequenceFlow id="s7c" sourceRef="GW_CashlessResult" targetRef="Task_PrintReceipt" name="Успешно"/>
    <bpmn:sequenceFlow id="s7d" sourceRef="GW_CashlessResult" targetRef="Gateway_PaymentChoice" name="Неуспешно"/>

    <!-- Cash path -->
    <bpmn:intermediateCatchEvent id="Catch_Cashier_Cash" name="Получить наличные">
      <bpmn:messageEventDefinition messageRef="msg_CashHanded"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:userTask id="Task_Cashier_GiveChange" name="Выдать сдачу (если нужно)"/>
    <bpmn:sequenceFlow id="s8a" sourceRef="Catch_Cashier_Cash" targetRef="Task_Cashier_GiveChange"/>
    <bpmn:sequenceFlow id="s8b" sourceRef="Task_Cashier_GiveChange" targetRef="Task_PrintReceipt"/>

    <!-- Mixed payment as loop collecting partial payments -->
    <bpmn:subProcess id="Sub_MixedPayment" name="Смешанная оплата (повторять, пока сумма &gt; 0)">
      <bpmn:standardLoopCharacteristics testBefore="true">
        <bpmn:loopCondition xsi:type="bpmn:tFormalExpression">${remainingAmount &gt; 0}</bpmn:loopCondition>
      </bpmn:standardLoopCharacteristics>

      <bpmn:startEvent id="SP_Mix_Start"/>
      <bpmn:exclusiveGateway id="GW_Mix_Choice" name="Выбрать платеж"/>
      <bpmn:intermediateCatchEvent id="SP_Mix_Cash" name="Получить наличные">
        <bpmn:messageEventDefinition messageRef="msg_CashHanded"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:userTask id="SP_Mix_GiveChange" name="Выдать сдачу (если нужно)"/>
      <bpmn:userTask id="SP_Mix_Cashless" name="Инициировать безнал на часть суммы"/>
      <bpmn:intermediateCatchEvent id="SP_Mix_Approved" name="Часть оплачена">
        <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:intermediateCatchEvent id="SP_Mix_Declined" name="Отказ/таймаут">
        <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:endEvent id="SP_Mix_End"/>

      <bpmn:sequenceFlow id="mx1" sourceRef="SP_Mix_Start" targetRef="GW_Mix_Choice"/>
      <bpmn:sequenceFlow id="mx2" sourceRef="GW_Mix_Choice" targetRef="SP_Mix_Cash" name="Наличные"/>
      <bpmn:sequenceFlow id="mx3" sourceRef="SP_Mix_Cash" targetRef="SP_Mix_GiveChange"/>
      <bpmn:sequenceFlow id="mx4" sourceRef="SP_Mix_GiveChange" targetRef="SP_Mix_End"/>
      <bpmn:sequenceFlow id="mx5" sourceRef="GW_Mix_Choice" targetRef="SP_Mix_Cashless" name="Безнал"/>
      <bpmn:sequenceFlow id="mx6" sourceRef="SP_Mix_Cashless" targetRef="Task_IS_SendPaymentReq"/>
      <bpmn:sequenceFlow id="mx7" sourceRef="SP_Mix_Approved" targetRef="SP_Mix_End"/>
      <bpmn:sequenceFlow id="mx8" sourceRef="SP_Mix_Declined" targetRef="GW_Mix_Choice"/>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="s9" sourceRef="Sub_MixedPayment" targetRef="Task_PrintReceipt"/>

    <bpmn:userTask id="Task_PrintReceipt" name="Пробить чек"/>
    <bpmn:endEvent id="End_FreeCheckout" name="Свободная касса">
      <bpmn:signalEventDefinition signalRef="sig_FreeCheckout"/>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="s10" sourceRef="Task_PrintReceipt" targetRef="End_FreeCheckout"/>

    <bpmn:endEvent id="End_Interrupted" name="Прерывание (ошибка)"/>

    <!-- IS: receive create sale and persist scans, handle payment exchange -->
    <bpmn:startEvent id="Start_IS_CreateSale" name="Создать ЭД 'продажа'">
      <bpmn:messageEventDefinition messageRef="msg_CreateSale"/>
    </bpmn:startEvent>
    <bpmn:task id="Task_IS_RegisterSale" name="Зарегистрировать ЭД 'продажа'"/>
    <bpmn:sequenceFlow id="is1" sourceRef="Start_IS_CreateSale" targetRef="Task_IS_RegisterSale"/>
    <bpmn:boundaryEvent id="BE_IS_Create_Error" name="Ошибка" attachedToRef="Task_IS_RegisterSale" cancelActivity="true">
      <bpmn:errorEventDefinition/>
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="is1_err" sourceRef="BE_IS_Create_Error" targetRef="End_Interrupted"/>

    <bpmn:intermediateCatchEvent id="Catch_IS_ScanItem" name="Получить пробитый товар">
      <bpmn:messageEventDefinition messageRef="msg_ScanItem"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:task id="Task_IS_PersistItem" name="Сохранить позицию (транзакционно)"/>
    <bpmn:intermediateThrowEvent id="Throw_IS_Persisted" name="Подтверждение сохранения">
      <bpmn:messageEventDefinition messageRef="msg_PersistItem"/>
    </bpmn:intermediateThrowEvent>
    <bpmn:sequenceFlow id="is2" sourceRef="Task_IS_RegisterSale" targetRef="Catch_IS_ScanItem"/>
    <bpmn:sequenceFlow id="is3" sourceRef="Catch_IS_ScanItem" targetRef="Task_IS_PersistItem"/>
    <bpmn:sequenceFlow id="is4" sourceRef="Task_IS_PersistItem" targetRef="Throw_IS_Persisted"/>
    <bpmn:sequenceFlow id="is5" sourceRef="Throw_IS_Persisted" targetRef="Catch_IS_ScanItem"/>

    <!-- Payment exchange -->
    <bpmn:task id="Task_IS_SendPaymentReq" name="Сформировать запрос безнала и отправить"/>
    <bpmn:intermediateCatchEvent id="Catch_IS_PaymentApproved" name="Оплата подтверждена">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:intermediateCatchEvent id="Catch_IS_PaymentDeclined" name="Отказ/таймаут">
      <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:intermediateThrowEvent id="Throw_IS_PaymentApproved" name="Отправить подтверждение кассиру">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Throw_IS_PaymentDeclined" name="Отправить отказ кассиру">
      <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
    </bpmn:intermediateThrowEvent>

    <bpmn:sequenceFlow id="is6" sourceRef="Task_IS_SendPaymentReq" targetRef="Catch_IS_PaymentApproved"/>
    <bpmn:sequenceFlow id="is6b" sourceRef="Task_IS_SendPaymentReq" targetRef="Catch_IS_PaymentDeclined"/>
    <bpmn:sequenceFlow id="is7" sourceRef="Catch_IS_PaymentApproved" targetRef="Throw_IS_PaymentApproved"/>
    <bpmn:sequenceFlow id="is8" sourceRef="Catch_IS_PaymentDeclined" targetRef="Throw_IS_PaymentDeclined"/>
  </bpmn:process>

  <!-- Acquirer process -->
  <bpmn:process id="Process_Acquirer" name="Банк-эквайер" isExecutable="false">
    <bpmn:startEvent id="Start_Acq_Authorize" name="Получить запрос авторизации">
      <bpmn:messageEventDefinition messageRef="msg_PaymentRequest"/>
    </bpmn:startEvent>
    <bpmn:userTask id="Task_Acq_CheckBalance" name="Проверить баланс / 3DS / антифрод"/>
    <bpmn:exclusiveGateway id="GW_Acq_Result" name="Решение"/>
    <bpmn:task id="Task_Acq_Approve" name="Отправить подтверждение"/>
    <bpmn:task id="Task_Acq_Decline" name="Отправить отказ"/>
    <bpmn:endEvent id="End_Acq"/>

    <bpmn:sequenceFlow id="aq1" sourceRef="Start_Acq_Authorize" targetRef="Task_Acq_CheckBalance"/>
    <bpmn:sequenceFlow id="aq2" sourceRef="Task_Acq_CheckBalance" targetRef="GW_Acq_Result"/>
    <bpmn:sequenceFlow id="aq3a" sourceRef="GW_Acq_Result" targetRef="Task_Acq_Approve" name="OK"/>
    <bpmn:sequenceFlow id="aq3b" sourceRef="GW_Acq_Result" targetRef="Task_Acq_Decline" name="Fail/Timeout"/>
    <bpmn:sequenceFlow id="aq4a" sourceRef="Task_Acq_Approve" targetRef="End_Acq"/>
    <bpmn:sequenceFlow id="aq4b" sourceRef="Task_Acq_Decline" targetRef="End_Acq"/>
  </bpmn:process>
</bpmn:definitions>

<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Definitions_Shopping" targetNamespace="https://example.com/bpmn/shopping">
  <!-- Messages and Signals -->
  <bpmn:message id="msg_ItemsOnBelt" name="Items on belt"/>
  <bpmn:message id="msg_CreateSale" name="Create Sale Document"/>
  <bpmn:message id="msg_ScanItem" name="Scan Item"/>
  <bpmn:message id="msg_PersistItem" name="Persist Item Transactionally"/>
  <bpmn:message id="msg_PaymentRequest" name="Payment Authorization Request"/>
  <bpmn:message id="msg_PaymentApproved" name="Payment Approved"/>
  <bpmn:message id="msg_PaymentDeclined" name="Payment Declined"/>
  <bpmn:message id="msg_CashHanded" name="Cash Handed Over"/>
  <bpmn:message id="msg_ChangeGiven" name="Change Given"/>
  <bpmn:signal id="sig_FreeCheckout" name="Free Checkout"/>

  <!-- Collaboration with participants -->
  <bpmn:collaboration id="Collab_Shopping">
    <bpmn:participant id="Pool_Customer" name="Покупатель" processRef="Process_Customer"/>
    <bpmn:participant id="Pool_Store" name="Магазин" processRef="Process_Store"/>
    <bpmn:participant id="Pool_Acquirer" name="Банк-эквайер" processRef="Process_Acquirer"/>

    <!-- Message Flows (declared here; elements referenced inside processes) -->
    <!-- Customer puts items on belt -> Cashier starts service -->
    <bpmn:messageFlow id="mf_ItemsOnBelt" name="Items on belt" sourceRef="Task_PutItemsOnBelt" targetRef="Start_Cashier_Service" messageRef="msg_ItemsOnBelt"/>

    <!-- Cashier -> IS: Create Sale -->
    <bpmn:messageFlow id="mf_CreateSale" name="Create Sale" sourceRef="Task_CreateSale" targetRef="Start_IS_CreateSale" messageRef="msg_CreateSale"/>

    <!-- Cashier -> IS: Scan Item, IS -> Cashier: Persist Ack (optional) -->
    <bpmn:messageFlow id="mf_ScanItem" name="Scan Item" sourceRef="Task_ScanItem" targetRef="Catch_IS_ScanItem" messageRef="msg_ScanItem"/>
    <bpmn:messageFlow id="mf_PersistAck" name="Persisted" sourceRef="Throw_IS_Persisted" targetRef="Catch_Cashier_Persisted" messageRef="msg_PersistItem"/>

    <!-- Noncash: Store IS <-> Acquirer -->
    <bpmn:messageFlow id="mf_PaymentRequest" name="Payment Request" sourceRef="Task_IS_SendPaymentReq" targetRef="Start_Acq_Authorize" messageRef="msg_PaymentRequest"/>
    <bpmn:messageFlow id="mf_PaymentApproved" name="Approved" sourceRef="Task_Acq_Approve" targetRef="Catch_IS_PaymentApproved" messageRef="msg_PaymentApproved"/>
    <bpmn:messageFlow id="mf_PaymentDeclined" name="Declined" sourceRef="Task_Acq_Decline" targetRef="Catch_IS_PaymentDeclined" messageRef="msg_PaymentDeclined"/>

    <!-- IS -> Cashier: authorization result -->
    <bpmn:messageFlow id="mf_IS_to_Cashier_Approved" name="Approved" sourceRef="Throw_IS_PaymentApproved" targetRef="Catch_Cashier_Approved" messageRef="msg_PaymentApproved"/>
    <bpmn:messageFlow id="mf_IS_to_Cashier_Declined" name="Declined" sourceRef="Throw_IS_PaymentDeclined" targetRef="Catch_Cashier_Declined" messageRef="msg_PaymentDeclined"/>

    <!-- Cash: Customer -> Cashier and back for change -->
    <bpmn:messageFlow id="mf_CashToCashier" name="Hand Cash" sourceRef="Task_Customer_HandCash" targetRef="Catch_Cashier_Cash" messageRef="msg_CashHanded"/>
    <bpmn:messageFlow id="mf_ChangeToCustomer" name="Give Change" sourceRef="Task_Cashier_GiveChange" targetRef="Catch_Customer_Change" messageRef="msg_ChangeGiven"/>
  </bpmn:collaboration>

  <!-- Customer process -->
  <bpmn:process id="Process_Customer" name="Покупатель" isExecutable="false">
    <bpmn:startEvent id="Start_NeedGroceries" name="Продукты закончились"/>
    <bpmn:sequenceFlow id="flow1" sourceRef="Start_NeedGroceries" targetRef="Task_GoToStore"/>

    <bpmn:userTask id="Task_GoToStore" name="Отправиться в магазин"/>
    <bpmn:sequenceFlow id="flow2" sourceRef="Task_GoToStore" targetRef="Task_TakeBasket"/>

    <bpmn:userTask id="Task_TakeBasket" name="Взять корзинку и пройти в зал"/>
    <bpmn:sequenceFlow id="flow3" sourceRef="Task_TakeBasket" targetRef="Task_SelectProducts"/>

    <bpmn:subProcess id="Task_SelectProducts" name="Подбор товаров (по списку)">
      <bpmn:multiInstanceLoopCharacteristics isSequential="false"/>
      <bpmn:startEvent id="SP_Start_Select"/>
      <bpmn:userTask id="SP_Task_PickItem" name="Выбрать товар"/>
      <bpmn:endEvent id="SP_End_Select"/>
      <bpmn:sequenceFlow id="sp_f1" sourceRef="SP_Start_Select" targetRef="SP_Task_PickItem"/>
      <bpmn:sequenceFlow id="sp_f2" sourceRef="SP_Task_PickItem" targetRef="SP_End_Select"/>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="flow4" sourceRef="Task_SelectProducts" targetRef="Task_WaitQueue"/>

    <bpmn:userTask id="Task_WaitQueue" name="Ждать очереди в зоне касс"/>
    <bpmn:sequenceFlow id="flow5" sourceRef="Task_WaitQueue" targetRef="Task_AwaitDivider"/>

    <bpmn:intermediateCatchEvent id="Task_AwaitDivider" name="Табличка на ленте: закончено">
      <bpmn:timerEventDefinition/>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="flow6" sourceRef="Task_AwaitDivider" targetRef="Task_PutItemsOnBelt"/>

    <bpmn:sendTask id="Task_PutItemsOnBelt" name="Выкладывать товары на ленту" messageRef="msg_ItemsOnBelt"/>
    <bpmn:sequenceFlow id="flow7" sourceRef="Task_PutItemsOnBelt" targetRef="Task_DecidePayment"/>

    <!-- Payment interaction from customer's side -->
    <bpmn:exclusiveGateway id="Task_DecidePayment" name="Выбор способа оплаты"/>
    <bpmn:sequenceFlow id="flow8_cashless" sourceRef="Task_DecidePayment" targetRef="Task_WaitApproval" name="Безнал"/>
    <bpmn:sequenceFlow id="flow8_cash" sourceRef="Task_DecidePayment" targetRef="Task_Customer_HandCash" name="Наличные"/>
    <bpmn:sequenceFlow id="flow8_mixed" sourceRef="Task_DecidePayment" targetRef="Task_WaitApproval" name="Смешанная"/>

    <bpmn:intermediateCatchEvent id="Task_WaitApproval" name="Ждать подтверждения оплаты">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="flow9" sourceRef="Task_WaitApproval" targetRef="End_TakeGoods"/>

    <bpmn:sendTask id="Task_Customer_HandCash" name="Передать наличные" messageRef="msg_CashHanded"/>
    <bpmn:sequenceFlow id="flow10" sourceRef="Task_Customer_HandCash" targetRef="Catch_Customer_Change"/>

    <bpmn:intermediateCatchEvent id="Catch_Customer_Change" name="Получить сдачу (при необходимости)">
      <bpmn:messageEventDefinition messageRef="msg_ChangeGiven"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:sequenceFlow id="flow11" sourceRef="Catch_Customer_Change" targetRef="End_TakeGoods"/>

    <bpmn:endEvent id="End_TakeGoods" name="Забрать товары и уйти домой">
      <bpmn:terminateEventDefinition/>
    </bpmn:endEvent>
  </bpmn:process>

  <!-- Store (Cashier + IS) process -->
  <bpmn:process id="Process_Store" name="Магазин" isExecutable="false">
    <bpmn:laneSet id="LaneSet_Store">
      <bpmn:lane id="Lane_Cashier" name="Кассир">
        <bpmn:flowNodeRef>Start_Cashier_Service</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_CreateSale</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Sub_ScanItems</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_OfferPromos</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Gateway_PaymentChoice</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_InitiateCashless</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Approved</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Declined</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Persisted</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_ScanItem</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_Cashier_Cash</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_Cashier_GiveChange</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_PrintReceipt</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>End_FreeCheckout</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_IS" name="ИС Магазина">
        <bpmn:flowNodeRef>Start_IS_CreateSale</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_IS_RegisterSale</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_IS_ScanItem</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Throw_IS_Persisted</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_IS_SendPaymentReq</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_IS_PaymentApproved</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Catch_IS_PaymentDeclined</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Throw_IS_PaymentApproved</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Throw_IS_PaymentDeclined</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>

    <!-- Cashier: start when items on belt -->
    <bpmn:startEvent id="Start_Cashier_Service" name="Начать обслуживание">
      <bpmn:messageEventDefinition messageRef="msg_ItemsOnBelt"/>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="s1" sourceRef="Start_Cashier_Service" targetRef="Task_CreateSale"/>

    <bpmn:sendTask id="Task_CreateSale" name="Создать ЭД 'продажа'" messageRef="msg_CreateSale"/>
    <bpmn:boundaryEvent id="BE_CreateSale_Error" name="Ошибка создания" attachedToRef="Task_CreateSale" cancelActivity="true">
      <bpmn:errorEventDefinition/>
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="s1_err" sourceRef="BE_CreateSale_Error" targetRef="End_Interrupted"/>
    <bpmn:sequenceFlow id="s2" sourceRef="Task_CreateSale" targetRef="Sub_ScanItems"/>

    <!-- Scanning loop with transactional persistence ack from IS -->
    <bpmn:subProcess id="Sub_ScanItems" name="Пробить все товары">
      <bpmn:standardLoopCharacteristics testBefore="true">
        <bpmn:loopCondition xsi:type="bpmn:tFormalExpression">${hasMoreItems}</bpmn:loopCondition>
      </bpmn:standardLoopCharacteristics>

      <bpmn:startEvent id="SP_Start_Scan"/>
      <bpmn:sequenceFlow id="ss1" sourceRef="SP_Start_Scan" targetRef="Task_ScanItem"/>

      <bpmn:sendTask id="Task_ScanItem" name="Пробить товар" messageRef="msg_ScanItem"/>
      <bpmn:intermediateCatchEvent id="Catch_Cashier_Persisted" name="Сохранено (транзакционно)">
        <bpmn:messageEventDefinition messageRef="msg_PersistItem"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:sequenceFlow id="ss2" sourceRef="Task_ScanItem" targetRef="Catch_Cashier_Persisted"/>
      <bpmn:endEvent id="SP_End_Scan"/>
      <bpmn:sequenceFlow id="ss3" sourceRef="Catch_Cashier_Persisted" targetRef="SP_End_Scan"/>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="s3" sourceRef="Sub_ScanItems" targetRef="Task_OfferPromos"/>

    <bpmn:userTask id="Task_OfferPromos" name="Предложить акции и пакет"/>
    <bpmn:exclusiveGateway id="GW_PromoAccepted" name="Согласен?"/>
    <bpmn:sequenceFlow id="s4a" sourceRef="Task_OfferPromos" targetRef="GW_PromoAccepted"/>
    <bpmn:sequenceFlow id="s4b" sourceRef="GW_PromoAccepted" targetRef="Sub_ScanItems" name="Да"/>
    <bpmn:sequenceFlow id="s4c" sourceRef="GW_PromoAccepted" targetRef="Gateway_PaymentChoice" name="Нет"/>

    <bpmn:userTask id="Task_AnnounceTotal" name="Озвучить сумму и спросить способ"/>
    <bpmn:exclusiveGateway id="Gateway_PaymentChoice" name="Способ оплаты"/>
    <bpmn:sequenceFlow id="s5a" sourceRef="Gateway_PaymentChoice" targetRef="Task_InitiateCashless" name="Безнал"/>
    <bpmn:sequenceFlow id="s5b" sourceRef="Gateway_PaymentChoice" targetRef="Catch_Cashier_Cash" name="Наличные"/>
    <bpmn:sequenceFlow id="s5c" sourceRef="Gateway_PaymentChoice" targetRef="Sub_MixedPayment" name="Смешанная"/>
    <bpmn:sequenceFlow id="s5d" sourceRef="Task_AnnounceTotal" targetRef="Gateway_PaymentChoice"/>

    <!-- Cashless path -->
    <bpmn:userTask id="Task_InitiateCashless" name="Инициировать безнал"/>
    <bpmn:sequenceFlow id="s6" sourceRef="Task_InitiateCashless" targetRef="Task_IS_SendPaymentReq"/>

    <bpmn:intermediateCatchEvent id="Catch_Cashier_Approved" name="Оплата подтверждена">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:intermediateCatchEvent id="Catch_Cashier_Declined" name="Отказ/таймаут">
      <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:exclusiveGateway id="GW_CashlessResult" name="Результат безнала"/>
    <bpmn:sequenceFlow id="s7a" sourceRef="Catch_Cashier_Approved" targetRef="GW_CashlessResult"/>
    <bpmn:sequenceFlow id="s7b" sourceRef="Catch_Cashier_Declined" targetRef="GW_CashlessResult"/>
    <bpmn:sequenceFlow id="s7c" sourceRef="GW_CashlessResult" targetRef="Task_PrintReceipt" name="Успешно"/>
    <bpmn:sequenceFlow id="s7d" sourceRef="GW_CashlessResult" targetRef="Gateway_PaymentChoice" name="Неуспешно"/>

    <!-- Cash path -->
    <bpmn:intermediateCatchEvent id="Catch_Cashier_Cash" name="Получить наличные">
      <bpmn:messageEventDefinition messageRef="msg_CashHanded"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:userTask id="Task_Cashier_GiveChange" name="Выдать сдачу (если нужно)"/>
    <bpmn:sequenceFlow id="s8a" sourceRef="Catch_Cashier_Cash" targetRef="Task_Cashier_GiveChange"/>
    <bpmn:sequenceFlow id="s8b" sourceRef="Task_Cashier_GiveChange" targetRef="Task_PrintReceipt"/>

    <!-- Mixed payment as loop collecting partial payments -->
    <bpmn:subProcess id="Sub_MixedPayment" name="Смешанная оплата (повторять, пока сумма &gt; 0)">
      <bpmn:standardLoopCharacteristics testBefore="true">
        <bpmn:loopCondition xsi:type="bpmn:tFormalExpression">${remainingAmount &gt; 0}</bpmn:loopCondition>
      </bpmn:standardLoopCharacteristics>

      <bpmn:startEvent id="SP_Mix_Start"/>
      <bpmn:exclusiveGateway id="GW_Mix_Choice" name="Выбрать платеж"/>
      <bpmn:intermediateCatchEvent id="SP_Mix_Cash" name="Получить наличные">
        <bpmn:messageEventDefinition messageRef="msg_CashHanded"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:userTask id="SP_Mix_GiveChange" name="Выдать сдачу (если нужно)"/>
      <bpmn:userTask id="SP_Mix_Cashless" name="Инициировать безнал на часть суммы"/>
      <bpmn:intermediateCatchEvent id="SP_Mix_Approved" name="Часть оплачена">
        <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:intermediateCatchEvent id="SP_Mix_Declined" name="Отказ/таймаут">
        <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
      </bpmn:intermediateCatchEvent>
      <bpmn:endEvent id="SP_Mix_End"/>

      <bpmn:sequenceFlow id="mx1" sourceRef="SP_Mix_Start" targetRef="GW_Mix_Choice"/>
      <bpmn:sequenceFlow id="mx2" sourceRef="GW_Mix_Choice" targetRef="SP_Mix_Cash" name="Наличные"/>
      <bpmn:sequenceFlow id="mx3" sourceRef="SP_Mix_Cash" targetRef="SP_Mix_GiveChange"/>
      <bpmn:sequenceFlow id="mx4" sourceRef="SP_Mix_GiveChange" targetRef="SP_Mix_End"/>
      <bpmn:sequenceFlow id="mx5" sourceRef="GW_Mix_Choice" targetRef="SP_Mix_Cashless" name="Безнал"/>
      <bpmn:sequenceFlow id="mx6" sourceRef="SP_Mix_Cashless" targetRef="Task_IS_SendPaymentReq"/>
      <bpmn:sequenceFlow id="mx7" sourceRef="SP_Mix_Approved" targetRef="SP_Mix_End"/>
      <bpmn:sequenceFlow id="mx8" sourceRef="SP_Mix_Declined" targetRef="GW_Mix_Choice"/>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="s9" sourceRef="Sub_MixedPayment" targetRef="Task_PrintReceipt"/>

    <bpmn:userTask id="Task_PrintReceipt" name="Пробить чек"/>
    <bpmn:endEvent id="End_FreeCheckout" name="Свободная касса">
      <bpmn:signalEventDefinition signalRef="sig_FreeCheckout"/>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="s10" sourceRef="Task_PrintReceipt" targetRef="End_FreeCheckout"/>

    <bpmn:endEvent id="End_Interrupted" name="Прерывание (ошибка)"/>

    <!-- IS: receive create sale and persist scans, handle payment exchange -->
    <bpmn:startEvent id="Start_IS_CreateSale" name="Создать ЭД 'продажа'">
      <bpmn:messageEventDefinition messageRef="msg_CreateSale"/>
    </bpmn:startEvent>
    <bpmn:task id="Task_IS_RegisterSale" name="Зарегистрировать ЭД 'продажа'"/>
    <bpmn:sequenceFlow id="is1" sourceRef="Start_IS_CreateSale" targetRef="Task_IS_RegisterSale"/>
    <bpmn:boundaryEvent id="BE_IS_Create_Error" name="Ошибка" attachedToRef="Task_IS_RegisterSale" cancelActivity="true">
      <bpmn:errorEventDefinition/>
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="is1_err" sourceRef="BE_IS_Create_Error" targetRef="End_Interrupted"/>

    <bpmn:intermediateCatchEvent id="Catch_IS_ScanItem" name="Получить пробитый товар">
      <bpmn:messageEventDefinition messageRef="msg_ScanItem"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:task id="Task_IS_PersistItem" name="Сохранить позицию (транзакционно)"/>
    <bpmn:intermediateThrowEvent id="Throw_IS_Persisted" name="Подтверждение сохранения">
      <bpmn:messageEventDefinition messageRef="msg_PersistItem"/>
    </bpmn:intermediateThrowEvent>
    <bpmn:sequenceFlow id="is2" sourceRef="Task_IS_RegisterSale" targetRef="Catch_IS_ScanItem"/>
    <bpmn:sequenceFlow id="is3" sourceRef="Catch_IS_ScanItem" targetRef="Task_IS_PersistItem"/>
    <bpmn:sequenceFlow id="is4" sourceRef="Task_IS_PersistItem" targetRef="Throw_IS_Persisted"/>
    <bpmn:sequenceFlow id="is5" sourceRef="Throw_IS_Persisted" targetRef="Catch_IS_ScanItem"/>

    <!-- Payment exchange -->
    <bpmn:task id="Task_IS_SendPaymentReq" name="Сформировать запрос безнала и отправить"/>
    <bpmn:intermediateCatchEvent id="Catch_IS_PaymentApproved" name="Оплата подтверждена">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:intermediateCatchEvent id="Catch_IS_PaymentDeclined" name="Отказ/таймаут">
      <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
    </bpmn:intermediateCatchEvent>
    <bpmn:intermediateThrowEvent id="Throw_IS_PaymentApproved" name="Отправить подтверждение кассиру">
      <bpmn:messageEventDefinition messageRef="msg_PaymentApproved"/>
    </bpmn:intermediateThrowEvent>
    <bpmn:intermediateThrowEvent id="Throw_IS_PaymentDeclined" name="Отправить отказ кассиру">
      <bpmn:messageEventDefinition messageRef="msg_PaymentDeclined"/>
    </bpmn:intermediateThrowEvent>

    <bpmn:sequenceFlow id="is6" sourceRef="Task_IS_SendPaymentReq" targetRef="Catch_IS_PaymentApproved"/>
    <bpmn:sequenceFlow id="is6b" sourceRef="Task_IS_SendPaymentReq" targetRef="Catch_IS_PaymentDeclined"/>
    <bpmn:sequenceFlow id="is7" sourceRef="Catch_IS_PaymentApproved" targetRef="Throw_IS_PaymentApproved"/>
    <bpmn:sequenceFlow id="is8" sourceRef="Catch_IS_PaymentDeclined" targetRef="Throw_IS_PaymentDeclined"/>
  </bpmn:process>

  <!-- Acquirer process -->
  <bpmn:process id="Process_Acquirer" name="Банк-эквайер" isExecutable="false">
    <bpmn:startEvent id="Start_Acq_Authorize" name="Получить запрос авторизации">
      <bpmn:messageEventDefinition messageRef="msg_PaymentRequest"/>
    </bpmn:startEvent>
    <bpmn:userTask id="Task_Acq_CheckBalance" name="Проверить баланс / 3DS / антифрод"/>
    <bpmn:exclusiveGateway id="GW_Acq_Result" name="Решение"/>
    <bpmn:task id="Task_Acq_Approve" name="Отправить подтверждение"/>
    <bpmn:task id="Task_Acq_Decline" name="Отправить отказ"/>
    <bpmn:endEvent id="End_Acq"/>

    <bpmn:sequenceFlow id="aq1" sourceRef="Start_Acq_Authorize" targetRef="Task_Acq_CheckBalance"/>
    <bpmn:sequenceFlow id="aq2" sourceRef="Task_Acq_CheckBalance" targetRef="GW_Acq_Result"/>
    <bpmn:sequenceFlow id="aq3a" sourceRef="GW_Acq_Result" targetRef="Task_Acq_Approve" name="OK"/>
    <bpmn:sequenceFlow id="aq3b" sourceRef="GW_Acq_Result" targetRef="Task_Acq_Decline" name="Fail/Timeout"/>
    <bpmn:sequenceFlow id="aq4a" sourceRef="Task_Acq_Approve" targetRef="End_Acq"/>
    <bpmn:sequenceFlow id="aq4b" sourceRef="Task_Acq_Decline" targetRef="End_Acq"/>
  </bpmn:process>
</bpmn:definitions>
